================================================================================
         UBER SYSTEM DESIGN
         Chapter 3: Real-Time Matching and Dispatch
================================================================================

The matching system is the brain of Uberâ€”deciding which driver gets
which ride request. This chapter covers matching algorithms, dispatch
optimization, and the real-time infrastructure that makes it work.


================================================================================
SECTION 3.1: THE MATCHING PROBLEM
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  WHAT IS MATCHING?                                                     â”‚
    â”‚                                                                         â”‚
    â”‚  Given:                                                                â”‚
    â”‚  â€¢ A rider requesting a ride at location P                            â”‚
    â”‚  â€¢ N available drivers near P                                         â”‚
    â”‚                                                                         â”‚
    â”‚  Find:                                                                 â”‚
    â”‚  â€¢ The "best" driver to assign to this ride                          â”‚
    â”‚                                                                         â”‚
    â”‚  But what does "best" mean?                                           â”‚
    â”‚  â€¢ Shortest pickup time? (rider happiness)                           â”‚
    â”‚  â€¢ Shortest driver travel? (driver happiness)                        â”‚
    â”‚  â€¢ Best rating match?                                                 â”‚
    â”‚  â€¢ Vehicle type match?                                                â”‚
    â”‚  â€¢ Overall system efficiency?                                        â”‚
    â”‚                                                                         â”‚
    â”‚  CONSTRAINTS:                                                          â”‚
    â”‚  â€¢ Must be fast (<100ms decision)                                    â”‚
    â”‚  â€¢ Must be fair to drivers                                           â”‚
    â”‚  â€¢ Must minimize rider wait time                                     â”‚
    â”‚  â€¢ Must handle 1,000+ matches per second                             â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 3.2: MATCHING STRATEGIES
================================================================================

STRATEGY 1: NEAREST DRIVER (Simple)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  NEAREST DRIVER ALGORITHM                                             â”‚
    â”‚                                                                         â”‚
    â”‚  def find_best_driver(rider_location):                                â”‚
    â”‚      # 1. Find nearby drivers                                        â”‚
    â”‚      nearby = find_drivers_within(rider_location, radius=5km)        â”‚
    â”‚                                                                         â”‚
    â”‚      # 2. Calculate ETA for each                                     â”‚
    â”‚      for driver in nearby:                                            â”‚
    â”‚          driver.eta = calculate_eta(driver.location, rider_location) â”‚
    â”‚                                                                         â”‚
    â”‚      # 3. Return nearest                                             â”‚
    â”‚      return min(nearby, key=lambda d: d.eta)                         â”‚
    â”‚                                                                         â”‚
    â”‚  PROS:                                                                 â”‚
    â”‚  âœ“ Simple to implement                                               â”‚
    â”‚  âœ“ Fast                                                              â”‚
    â”‚  âœ“ Minimizes rider wait time                                        â”‚
    â”‚                                                                         â”‚
    â”‚  CONS:                                                                 â”‚
    â”‚  âœ— Not globally optimal                                              â”‚
    â”‚  âœ— Can be unfair to drivers (same drivers always get rides)        â”‚
    â”‚  âœ— Doesn't consider future demand                                   â”‚
    â”‚                                                                         â”‚
    â”‚  EXAMPLE OF WHY IT FAILS:                                             â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
    â”‚                                                                         â”‚
    â”‚       D1 â”€â”€â”€â”€â”€â”€â”€ R1 â”€â”€â”€â”€â”€â”€â”€ R2 â”€â”€â”€â”€â”€â”€â”€ D2                            â”‚
    â”‚       â”‚â†â”€â”€ 2minâ”€â”€â”‚â†â”€â”€ 5min â”€â”€â”‚â†â”€â”€ 2min â”€â”‚                            â”‚
    â”‚                                                                         â”‚
    â”‚  Nearest matching:                                                     â”‚
    â”‚  â€¢ R1 gets D1 (2 min)                                                â”‚
    â”‚  â€¢ R2 gets D2 (2 min)                                                â”‚
    â”‚  â€¢ Total: 4 minutes                                                  â”‚
    â”‚                                                                         â”‚
    â”‚  If we assigned:                                                       â”‚
    â”‚  â€¢ R1 gets D2 (7 min) â€” worse for R1                                â”‚
    â”‚  â€¢ R2 gets D1 (7 min) â€” worse for R2                                â”‚
    â”‚  â€¢ Total: 14 minutes â€” much worse!                                  â”‚
    â”‚                                                                         â”‚
    â”‚  In this case, nearest is optimal. But not always...                â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STRATEGY 2: BATCHED MATCHING (Uber's Approach)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  BATCHED MATCHING                                                      â”‚
    â”‚                                                                         â”‚
    â”‚  Instead of matching each request immediately, collect requests       â”‚
    â”‚  over a short window (2-5 seconds) and optimize globally.            â”‚
    â”‚                                                                         â”‚
    â”‚  Time: 0s           2s           4s                                   â”‚
    â”‚        â”‚            â”‚            â”‚                                    â”‚
    â”‚        â”‚  R1, R2,   â”‚  Compute   â”‚  R4, R5,                          â”‚
    â”‚        â”‚  R3 arrive â”‚  optimal   â”‚  R6 arrive                        â”‚
    â”‚        â”‚            â”‚  matching  â”‚                                    â”‚
    â”‚        â”‚            â”‚            â”‚                                    â”‚
    â”‚                                                                         â”‚
    â”‚  BIPARTITE MATCHING PROBLEM                                           â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                           â”‚
    â”‚                                                                         â”‚
    â”‚  Riders (left)        Drivers (right)                                 â”‚
    â”‚                                                                         â”‚
    â”‚       R1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ D1                                            â”‚
    â”‚          â•²            â•±                                                â”‚
    â”‚           â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±                                                 â”‚
    â”‚       R2 â”€â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€ D2                                             â”‚
    â”‚                 â•²                                                       â”‚
    â”‚       R3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ D3                                            â”‚
    â”‚                                                                         â”‚
    â”‚  Each edge has a cost (ETA).                                         â”‚
    â”‚  Find assignment that minimizes total cost.                          â”‚
    â”‚                                                                         â”‚
    â”‚  HUNGARIAN ALGORITHM                                                   â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
    â”‚  â€¢ Solves bipartite matching in O(nÂ³)                               â”‚
    â”‚  â€¢ For N riders, N drivers                                           â”‚
    â”‚  â€¢ Guarantees globally optimal solution                              â”‚
    â”‚                                                                         â”‚
    â”‚  SIMPLIFIED EXAMPLE:                                                   â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
    â”‚                                                                         â”‚
    â”‚  Cost matrix (ETA in minutes):                                       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
    â”‚  â”‚         â”‚  D1  â”‚  D2  â”‚  D3  â”‚                                    â”‚
    â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                          â”‚
    â”‚  â”‚   R1    â”‚  2   â”‚  5   â”‚  8   â”‚                                    â”‚
    â”‚  â”‚   R2    â”‚  4   â”‚  3   â”‚  6   â”‚                                    â”‚
    â”‚  â”‚   R3    â”‚  7   â”‚  6   â”‚  2   â”‚                                    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
    â”‚                                                                         â”‚
    â”‚  Nearest matching:                                                     â”‚
    â”‚  R1â†’D1(2), R2â†’D2(3), R3â†’D3(2) = Total 7 min âœ“ (optimal here)       â”‚
    â”‚                                                                         â”‚
    â”‚  But with more complex scenarios, batching helps!                    â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


STRATEGY 3: SCORING-BASED MATCHING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  SCORING FUNCTION                                                      â”‚
    â”‚                                                                         â”‚
    â”‚  Instead of just ETA, use a weighted score:                          â”‚
    â”‚                                                                         â”‚
    â”‚  score = w1 * eta_score                                              â”‚
    â”‚        + w2 * driver_rating_match                                    â”‚
    â”‚        + w3 * vehicle_type_score                                     â”‚
    â”‚        + w4 * driver_wait_time_fairness                              â”‚
    â”‚        + w5 * surge_price_willingness                                â”‚
    â”‚        + w6 * historical_acceptance_rate                             â”‚
    â”‚                                                                         â”‚
    â”‚  FACTORS:                                                              â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
    â”‚                                                                         â”‚
    â”‚  1. ETA Score (most important):                                      â”‚
    â”‚     eta_score = 1.0 - (eta_minutes / max_eta)                       â”‚
    â”‚                                                                         â”‚
    â”‚  2. Driver Rating Match:                                             â”‚
    â”‚     â€¢ Premium riders prefer high-rated drivers                       â”‚
    â”‚     â€¢ New drivers need rides to build rating                        â”‚
    â”‚                                                                         â”‚
    â”‚  3. Vehicle Type:                                                     â”‚
    â”‚     â€¢ Requested UberX? Don't show UberBlack driver                  â”‚
    â”‚     â€¢ Unless rider is willing to upgrade                            â”‚
    â”‚                                                                         â”‚
    â”‚  4. Fairness:                                                         â”‚
    â”‚     â€¢ Driver waiting 30 minutes gets priority                       â”‚
    â”‚     â€¢ Prevents some drivers from getting all rides                  â”‚
    â”‚                                                                         â”‚
    â”‚  5. Acceptance Rate:                                                  â”‚
    â”‚     â€¢ Driver who accepts 95% rides > 50% accepts                   â”‚
    â”‚     â€¢ Reduces wasted offers                                          â”‚
    â”‚                                                                         â”‚
    â”‚  def calculate_match_score(rider, driver):                           â”‚
    â”‚      eta = calculate_eta(driver.location, rider.pickup)              â”‚
    â”‚      eta_score = max(0, 1.0 - eta / 15.0)  # 15 min max             â”‚
    â”‚                                                                         â”‚
    â”‚      fairness = min(1.0, driver.wait_minutes / 20.0)                 â”‚
    â”‚                                                                         â”‚
    â”‚      acceptance = driver.acceptance_rate                              â”‚
    â”‚                                                                         â”‚
    â”‚      score = (                                                         â”‚
    â”‚          0.5 * eta_score +                                            â”‚
    â”‚          0.2 * fairness +                                             â”‚
    â”‚          0.2 * acceptance +                                           â”‚
    â”‚          0.1 * rating_score(rider, driver)                           â”‚
    â”‚      )                                                                 â”‚
    â”‚      return score                                                      â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 3.3: DISPATCH ARCHITECTURE
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  DISPATCH SERVICE ARCHITECTURE                                        â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚   Rider App                                                     â”‚  â”‚
    â”‚  â”‚       â”‚                                                         â”‚  â”‚
    â”‚  â”‚       â”‚ Request Ride                                           â”‚  â”‚
    â”‚  â”‚       â–¼                                                         â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚  â”‚                   API Gateway                            â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â”‚       â”‚                                                         â”‚  â”‚
    â”‚  â”‚       â–¼                                                         â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚  â”‚                 Ride Request Service                     â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  - Validate request                                      â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  - Check surge pricing                                   â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  - Calculate fare estimate                              â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  - Create ride request record                            â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â”‚       â”‚                                                         â”‚  â”‚
    â”‚  â”‚       â–¼                                                         â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚  â”‚                  Dispatch Service                        â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  (Core matching logic)                                   â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â”‚       â”‚                    â”‚                                    â”‚  â”‚
    â”‚  â”‚       â–¼                    â–¼                                    â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚  â”‚
    â”‚  â”‚  â”‚   Location   â”‚    â”‚    Supply    â”‚                          â”‚  â”‚
    â”‚  â”‚  â”‚   Service    â”‚    â”‚   Service    â”‚                          â”‚  â”‚
    â”‚  â”‚  â”‚              â”‚    â”‚  (Driver     â”‚                          â”‚  â”‚
    â”‚  â”‚  â”‚  "Nearby     â”‚    â”‚  availabilityâ”‚                          â”‚  â”‚
    â”‚  â”‚  â”‚   drivers"   â”‚    â”‚   status)    â”‚                          â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚
    â”‚  â”‚       â”‚                                                         â”‚  â”‚
    â”‚  â”‚       â–¼                                                         â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚  â”‚              Driver Communication Service                â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  - Send ride offer via push/socket                      â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  - Wait for response                                    â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚  - Handle timeout/rejection                             â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â”‚       â”‚                                                         â”‚  â”‚
    â”‚  â”‚       â–¼                                                         â”‚  â”‚
    â”‚  â”‚   Driver App                                                    â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 3.4: DISPATCH FLOW (SEQUENCE DIAGRAM)
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  RIDE REQUEST â†’ DRIVER ASSIGNMENT FLOW                                â”‚
    â”‚                                                                         â”‚
    â”‚  Rider     RideSvc    Dispatch    Location    Driver     DriverApp   â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚ Request  â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚ Find     â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚ Match    â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ Get nearbyâ”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ [D1,D2,D3]â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ Calculate scores     â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ Select D1            â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ Reserve driver       â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ Send offerâ”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚ ACCEPT â”‚
    â”‚    â”‚          â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ Update    â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚ status    â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚            â”‚        â”‚
    â”‚    â”‚          â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚ Match    â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚          â”‚ confirmedâ”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚ Driver   â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚    â”‚ assigned â”‚          â”‚           â”‚          â”‚            â”‚        â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


HANDLING DRIVER REJECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  WHAT IF DRIVER REJECTS OR TIMES OUT?                                 â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Dispatch sends offer to D1                                    â”‚  â”‚
    â”‚  â”‚       â”‚                                                         â”‚  â”‚
    â”‚  â”‚       â–¼                                                         â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚  â”‚
    â”‚  â”‚  â”‚ Wait    â”‚â—„â”€â”€â”€â”€ 15 second timeout                           â”‚  â”‚
    â”‚  â”‚  â”‚ for     â”‚                                                    â”‚  â”‚
    â”‚  â”‚  â”‚ responseâ”‚                                                    â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                    â”‚  â”‚
    â”‚  â”‚       â”‚                                                         â”‚  â”‚
    â”‚  â”‚       â–¼                                                         â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
    â”‚  â”‚  â”‚                    RESPONSE?                            â”‚   â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
    â”‚  â”‚       â”‚                 â”‚                    â”‚                  â”‚  â”‚
    â”‚  â”‚       â–¼                 â–¼                    â–¼                  â”‚  â”‚
    â”‚  â”‚   ACCEPTED          REJECTED            TIMEOUT               â”‚  â”‚
    â”‚  â”‚       â”‚                 â”‚                    â”‚                  â”‚  â”‚
    â”‚  â”‚       â”‚                 â”‚                    â”‚                  â”‚  â”‚
    â”‚  â”‚       â–¼                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
    â”‚  â”‚   Confirm                        â”‚                              â”‚  â”‚
    â”‚  â”‚   ride                           â–¼                              â”‚  â”‚
    â”‚  â”‚                          Try next driver (D2)                  â”‚  â”‚
    â”‚  â”‚                                  â”‚                              â”‚  â”‚
    â”‚  â”‚                                  â–¼                              â”‚  â”‚
    â”‚  â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚
    â”‚  â”‚                          â”‚ Max     â”‚                            â”‚  â”‚
    â”‚  â”‚                          â”‚ retries?â”‚                            â”‚  â”‚
    â”‚  â”‚                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                            â”‚  â”‚
    â”‚  â”‚                               â”‚                                 â”‚  â”‚
    â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚  â”‚
    â”‚  â”‚                   â–¼                       â–¼                     â”‚  â”‚
    â”‚  â”‚                  NO                      YES                    â”‚  â”‚
    â”‚  â”‚              Try D3                  Notify rider              â”‚  â”‚
    â”‚  â”‚                                     "No drivers                â”‚  â”‚
    â”‚  â”‚                                      available"                â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â”‚  RETRY STRATEGY:                                                       â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
    â”‚  â€¢ Try 3 drivers before giving up                                    â”‚
    â”‚  â€¢ Exclude previously tried drivers                                  â”‚
    â”‚  â€¢ May increase search radius on retry                               â”‚
    â”‚  â€¢ Track rejection for driver scoring                                â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 3.5: REAL-TIME COMMUNICATION
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  PUSH NOTIFICATIONS vs WEBSOCKETS                                     â”‚
    â”‚                                                                         â”‚
    â”‚  WEBSOCKETS (Preferred for active users)                              â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                               â”‚
    â”‚                                                                         â”‚
    â”‚  â€¢ Persistent TCP connection                                          â”‚
    â”‚  â€¢ Bi-directional communication                                       â”‚
    â”‚  â€¢ Sub-second latency                                                 â”‚
    â”‚  â€¢ Battery intensive (keep connection alive)                         â”‚
    â”‚                                                                         â”‚
    â”‚  Used for:                                                             â”‚
    â”‚  â€¢ Ride offers to drivers                                            â”‚
    â”‚  â€¢ Location updates during ride                                      â”‚
    â”‚  â€¢ Real-time ETA updates                                             â”‚
    â”‚                                                                         â”‚
    â”‚  PUSH NOTIFICATIONS (Fallback)                                        â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                        â”‚
    â”‚                                                                         â”‚
    â”‚  â€¢ APNs (iOS) / FCM (Android)                                        â”‚
    â”‚  â€¢ No persistent connection                                          â”‚
    â”‚  â€¢ Higher latency (1-5 seconds)                                      â”‚
    â”‚  â€¢ Works when app is backgrounded                                    â”‚
    â”‚                                                                         â”‚
    â”‚  Used for:                                                             â”‚
    â”‚  â€¢ Driver is offline, rider requests                                 â”‚
    â”‚  â€¢ Trip reminders                                                    â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  WEBSOCKET ARCHITECTURE                                               â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚   Driver Apps (1M connections)                                â”‚   â”‚
    â”‚  â”‚        â”‚                                                       â”‚   â”‚
    â”‚  â”‚        â”‚ WebSocket                                            â”‚   â”‚
    â”‚  â”‚        â–¼                                                       â”‚   â”‚
    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
    â”‚  â”‚   â”‚            Load Balancer (Sticky)                   â”‚    â”‚   â”‚
    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
    â”‚  â”‚        â”‚                                                       â”‚   â”‚
    â”‚  â”‚        â–¼                                                       â”‚   â”‚
    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚   â”‚
    â”‚  â”‚   â”‚ Gateway  â”‚  â”‚ Gateway  â”‚  â”‚ Gateway  â”‚  (100 servers)    â”‚   â”‚
    â”‚  â”‚   â”‚ Server 1 â”‚  â”‚ Server 2 â”‚  â”‚ Server N â”‚                    â”‚   â”‚
    â”‚  â”‚   â”‚          â”‚  â”‚          â”‚  â”‚          â”‚                    â”‚   â”‚
    â”‚  â”‚   â”‚ 10K conn â”‚  â”‚ 10K conn â”‚  â”‚ 10K conn â”‚                    â”‚   â”‚
    â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                    â”‚   â”‚
    â”‚  â”‚        â”‚             â”‚             â”‚                           â”‚   â”‚
    â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
    â”‚  â”‚                      â”‚                                         â”‚   â”‚
    â”‚  â”‚                      â–¼                                         â”‚   â”‚
    â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
    â”‚  â”‚   â”‚               Redis Pub/Sub                          â”‚    â”‚   â”‚
    â”‚  â”‚   â”‚  (Message routing between gateways)                  â”‚    â”‚   â”‚
    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
    â”‚  â”‚                      â”‚                                         â”‚   â”‚
    â”‚  â”‚                      â–¼                                         â”‚   â”‚
    â”‚  â”‚               Dispatch Service                                â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                                         â”‚
    â”‚  MESSAGE ROUTING:                                                      â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
    â”‚                                                                         â”‚
    â”‚  Problem: Driver D1 is connected to Gateway 3.                       â”‚
    â”‚           Dispatch runs on separate servers.                         â”‚
    â”‚           How does Dispatch send message to D1?                      â”‚
    â”‚                                                                         â”‚
    â”‚  Solution: Redis Pub/Sub                                              â”‚
    â”‚                                                                         â”‚
    â”‚  1. Each Gateway subscribes to channel for its connections:          â”‚
    â”‚     SUBSCRIBE gateway:3                                               â”‚
    â”‚                                                                         â”‚
    â”‚  2. Maintain mapping: driver_id â†’ gateway_id (in Redis)              â”‚
    â”‚     SET connection:D1 "gateway:3"                                    â”‚
    â”‚                                                                         â”‚
    â”‚  3. Dispatch publishes to correct channel:                           â”‚
    â”‚     gateway_id = GET connection:D1                                   â”‚
    â”‚     PUBLISH gateway:3 "{ride_offer...}"                              â”‚
    â”‚                                                                         â”‚
    â”‚  4. Gateway 3 receives message, sends to D1's socket                 â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 3.6: CONCURRENCY AND STATE MANAGEMENT
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  RACE CONDITIONS IN MATCHING                                          â”‚
    â”‚                                                                         â”‚
    â”‚  Problem: Multiple ride requests might try to match same driver      â”‚
    â”‚                                                                         â”‚
    â”‚  Time     Rider 1                    Rider 2                          â”‚
    â”‚   â”‚                                                                    â”‚
    â”‚   â”‚   Find nearby drivers           Find nearby drivers              â”‚
    â”‚   â”‚   â†’ D1, D2, D3                  â†’ D1, D2, D4                     â”‚
    â”‚   â”‚                                                                    â”‚
    â”‚   â”‚   Select best: D1               Select best: D1                  â”‚
    â”‚   â”‚                                                                    â”‚
    â”‚   â”‚   Send offer to D1              Send offer to D1                 â”‚
    â”‚   â”‚         â”‚                              â”‚                          â”‚
    â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º D1 gets 2 offers!                           â”‚
    â”‚   â”‚                      Chaos! ğŸ”¥                                   â”‚
    â”‚   â–¼                                                                    â”‚
    â”‚                                                                         â”‚
    â”‚  SOLUTION: DRIVER RESERVATION                                         â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                        â”‚
    â”‚                                                                         â”‚
    â”‚  // Before sending offer, atomically reserve driver                  â”‚
    â”‚                                                                         â”‚
    â”‚  SETNX driver:D1:reserved ride_request_123 EX 30                     â”‚
    â”‚                                                                         â”‚
    â”‚  // Only proceeds if we got the lock                                 â”‚
    â”‚  if (reserved successfully) {                                         â”‚
    â”‚      send_offer_to_driver(D1);                                        â”‚
    â”‚  } else {                                                              â”‚
    â”‚      // D1 already reserved, try D2                                  â”‚
    â”‚      select_next_best_driver();                                       â”‚
    â”‚  }                                                                     â”‚
    â”‚                                                                         â”‚
    â”‚  // After offer accepted/rejected, release                           â”‚
    â”‚  DEL driver:D1:reserved                                               â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  DRIVER STATE MACHINE                                                 â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚  â”‚
    â”‚  â”‚                      â”‚ OFFLINE  â”‚                               â”‚  â”‚
    â”‚  â”‚                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                               â”‚  â”‚
    â”‚  â”‚                           â”‚ Goes online                        â”‚  â”‚
    â”‚  â”‚                           â–¼                                     â”‚  â”‚
    â”‚  â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚  â”‚
    â”‚  â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚AVAILABLE â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  â”‚
    â”‚  â”‚        â”‚             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚                  â”‚ Ride offer        â”‚ Ride complete  â”‚  â”‚
    â”‚  â”‚        â”‚                  â–¼                   â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚             â”‚ RESERVED â”‚             â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚                  â”‚                   â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â”‚             â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â–¼             â–¼             â–¼     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚ TIMEOUT      ACCEPTED      REJECTED  â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â”‚             â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â–¼             â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â”‚EN_ROUTE  â”‚       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â”‚ Arrived     â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â–¼             â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â”‚ WAITING  â”‚       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â”‚ Pickup      â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â–¼             â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â”‚ON_TRIP   â”‚       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â”‚    â”‚             â”‚             â”‚     â”‚                â”‚  â”‚
    â”‚  â”‚        â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
CHAPTER SUMMARY
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  REAL-TIME MATCHING - KEY TAKEAWAYS                                   â”‚
    â”‚                                                                         â”‚
    â”‚  MATCHING STRATEGIES                                                   â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
    â”‚  â€¢ Nearest driver: Simple, fast, not globally optimal                â”‚
    â”‚  â€¢ Batched matching: Collect requests, optimize globally            â”‚
    â”‚  â€¢ Scoring-based: Multi-factor (ETA, fairness, rating)              â”‚
    â”‚                                                                         â”‚
    â”‚  DISPATCH ARCHITECTURE                                                 â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
    â”‚  â€¢ Stateless dispatch service for horizontal scaling                 â”‚
    â”‚  â€¢ Location service for nearby queries                               â”‚
    â”‚  â€¢ WebSocket gateways for real-time communication                    â”‚
    â”‚  â€¢ Redis Pub/Sub for message routing                                 â”‚
    â”‚                                                                         â”‚
    â”‚  CONCURRENCY                                                           â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
    â”‚  â€¢ Reserve driver before sending offer                               â”‚
    â”‚  â€¢ Use Redis SETNX for atomic reservation                           â”‚
    â”‚  â€¢ State machine for driver status                                   â”‚
    â”‚                                                                         â”‚
    â”‚  INTERVIEW TIP                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
    â”‚  Draw the dispatch flow sequence.                                    â”‚
    â”‚  Explain race condition and solution.                                â”‚
    â”‚  Discuss WebSocket vs Push trade-offs.                               â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
                              END OF CHAPTER 3
================================================================================

