================================================================================
         CHAPTER 22: IDEMPOTENT API DESIGN
         Making POST/PUT Operations Safe to Retry
================================================================================

Idempotency is critical for building reliable distributed systems.
This chapter consolidates patterns for making non-idempotent operations safe.


================================================================================
SECTION 22.1: UNDERSTANDING IDEMPOTENCY
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  WHAT IS IDEMPOTENCY?                                                  â”‚
    â”‚                                                                         â”‚
    â”‚  An operation is idempotent if calling it multiple times              â”‚
    â”‚  produces the same result as calling it once.                         â”‚
    â”‚                                                                         â”‚
    â”‚  Mathematically: f(f(x)) = f(x)                                       â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  NATURALLY IDEMPOTENT:                                         â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  GET /users/123           â†’ Always returns same user          â”‚  â”‚
    â”‚  â”‚  PUT /users/123 {name}    â†’ Sets name to same value           â”‚  â”‚
    â”‚  â”‚  DELETE /users/123        â†’ User gone (already gone = same)   â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  NOT NATURALLY IDEMPOTENT:                                     â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  POST /orders             â†’ Creates NEW order each time!      â”‚  â”‚
    â”‚  â”‚  POST /payments           â†’ Charges card each time!           â”‚  â”‚
    â”‚  â”‚  POST /emails/send        â†’ Sends duplicate emails!           â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â”‚  HTTP METHOD IDEMPOTENCY:                                              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚ Method â”‚ Idempotent â”‚ Safe â”‚ Notes                           â”‚    â”‚
    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
    â”‚  â”‚ GET    â”‚ Yes        â”‚ Yes  â”‚ Read-only                       â”‚    â”‚
    â”‚  â”‚ HEAD   â”‚ Yes        â”‚ Yes  â”‚ Read-only                       â”‚    â”‚
    â”‚  â”‚ PUT    â”‚ Yes        â”‚ No   â”‚ Full replacement                â”‚    â”‚
    â”‚  â”‚ DELETE â”‚ Yes        â”‚ No   â”‚ Delete (already deleted = ok)   â”‚    â”‚
    â”‚  â”‚ POST   â”‚ NO         â”‚ No   â”‚ Creates new resource            â”‚    â”‚
    â”‚  â”‚ PATCH  â”‚ NO         â”‚ No   â”‚ Depends on operation            â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WHY IDEMPOTENCY MATTERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  THE NETWORK IS UNRELIABLE                                             â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  SCENARIO: Payment request                                     â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Client â”€â”€â”€â”€ POST /payments â”€â”€â”€â”€â–º Server                       â”‚  â”‚
    â”‚  â”‚     â”‚                               â”‚                           â”‚  â”‚
    â”‚  â”‚     â”‚                               â”‚ (processes payment âœ“)    â”‚  â”‚
    â”‚  â”‚     â”‚                               â”‚                           â”‚  â”‚
    â”‚  â”‚     â”‚ â—„â”€â”€â”€â”€ TIMEOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ (response lost!)        â”‚  â”‚
    â”‚  â”‚     â”‚                                                           â”‚  â”‚
    â”‚  â”‚  Client thinks: "Failed, let me retry"                         â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Client â”€â”€â”€â”€ POST /payments â”€â”€â”€â”€â–º Server                       â”‚  â”‚
    â”‚  â”‚                                       â”‚                         â”‚  â”‚
    â”‚  â”‚                                       â”‚ (charges AGAIN! ğŸ’¸)    â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  RESULT: Customer charged twice! ğŸ˜±                           â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â”‚  FAILURE MODES THAT CAUSE RETRIES:                                    â”‚
    â”‚  â€¢ Network timeout                                                     â”‚
    â”‚  â€¢ Load balancer retry                                                â”‚
    â”‚  â€¢ Client retry (mobile app reconnect)                               â”‚
    â”‚  â€¢ Message queue redelivery                                          â”‚
    â”‚  â€¢ Kubernetes pod restart mid-request                                â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 22.2: IDEMPOTENCY KEY PATTERN
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  THE SOLUTION: IDEMPOTENCY KEYS                                        â”‚
    â”‚                                                                         â”‚
    â”‚  Client sends a unique key with each logical operation.               â”‚
    â”‚  Server uses this key to detect and deduplicate retries.              â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  REQUEST 1:                                                     â”‚  â”‚
    â”‚  â”‚  POST /payments                                                 â”‚  â”‚
    â”‚  â”‚  Idempotency-Key: ord_123_pay_1                                â”‚  â”‚
    â”‚  â”‚  { "amount": 100, "card": "..." }                              â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Server: Key not seen â†’ Process payment â†’ Return 200           â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  REQUEST 2 (retry, same key):                                  â”‚  â”‚
    â”‚  â”‚  POST /payments                                                 â”‚  â”‚
    â”‚  â”‚  Idempotency-Key: ord_123_pay_1  â† SAME KEY                    â”‚  â”‚
    â”‚  â”‚  { "amount": 100, "card": "..." }                              â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Server: Key exists â†’ Return cached 200 (no reprocessing!)    â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


IMPLEMENTATION FLOW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  IDEMPOTENCY KEY HANDLING FLOW                                         â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Request arrives with Idempotency-Key header                   â”‚  â”‚
    â”‚  â”‚         â”‚                                                       â”‚  â”‚
    â”‚  â”‚         â–¼                                                       â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚  â”‚ Step 1: Check cache (Redis)                             â”‚  â”‚  â”‚
    â”‚  â”‚  â”‚         GET idem:{key}                                  â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â”‚         â”‚                                                       â”‚  â”‚
    â”‚  â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                                 â”‚  â”‚
    â”‚  â”‚    â”‚         â”‚                                                 â”‚  â”‚
    â”‚  â”‚  Found    Not Found                                            â”‚  â”‚
    â”‚  â”‚    â”‚         â”‚                                                 â”‚  â”‚
    â”‚  â”‚    â–¼         â–¼                                                 â”‚  â”‚
    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
    â”‚  â”‚  â”‚Status?â”‚ â”‚ Step 2: Mark as "processing" (atomic)       â”‚    â”‚  â”‚
    â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â”‚         SET idem:{key} "processing" NX EX   â”‚    â”‚  â”‚
    â”‚  â”‚      â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
    â”‚  â”‚   â”Œâ”€â”€â”´â”€â”€â”         â”‚                                           â”‚  â”‚
    â”‚  â”‚   â”‚     â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                      â”‚  â”‚
    â”‚  â”‚ processing complete   â”‚         â”‚                              â”‚  â”‚
    â”‚  â”‚   â”‚     â”‚          Success   Failed (race)                    â”‚  â”‚
    â”‚  â”‚   â–¼     â–¼             â”‚         â”‚                              â”‚  â”‚
    â”‚  â”‚ Return Return      Process   Return 409                       â”‚  â”‚
    â”‚  â”‚  409   cached      request   "In progress"                    â”‚  â”‚
    â”‚  â”‚        response       â”‚                                        â”‚  â”‚
    â”‚  â”‚                       â–¼                                        â”‚  â”‚
    â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
    â”‚  â”‚              â”‚ Step 3: Execute business logic              â”‚  â”‚  â”‚
    â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
    â”‚  â”‚                       â”‚                                        â”‚  â”‚
    â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚  â”‚
    â”‚  â”‚           Success           Failure                           â”‚  â”‚
    â”‚  â”‚              â”‚                 â”‚                               â”‚  â”‚
    â”‚  â”‚              â–¼                 â–¼                               â”‚  â”‚
    â”‚  â”‚         Cache result     Delete key                           â”‚  â”‚
    â”‚  â”‚         (24hr TTL)       (allow retry)                        â”‚  â”‚
    â”‚  â”‚              â”‚                 â”‚                               â”‚  â”‚
    â”‚  â”‚              â–¼                 â–¼                               â”‚  â”‚
    â”‚  â”‚         Return 200       Return error                         â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


CODE IMPLEMENTATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  PYTHON IMPLEMENTATION                                                  â”‚
    â”‚                                                                         â”‚
    â”‚  import redis                                                           â”‚
    â”‚  import json                                                            â”‚
    â”‚  import uuid                                                            â”‚
    â”‚                                                                         â”‚
    â”‚  redis_client = redis.Redis()                                          â”‚
    â”‚  IDEMPOTENCY_TTL = 86400  # 24 hours                                   â”‚
    â”‚                                                                         â”‚
    â”‚  def idempotent_handler(func):                                         â”‚
    â”‚      def wrapper(request):                                             â”‚
    â”‚          # Get idempotency key from header                             â”‚
    â”‚          idem_key = request.headers.get('Idempotency-Key')            â”‚
    â”‚          if not idem_key:                                              â”‚
    â”‚              return 400, {"error": "Idempotency-Key required"}        â”‚
    â”‚                                                                         â”‚
    â”‚          cache_key = f"idem:{idem_key}"                               â”‚
    â”‚                                                                         â”‚
    â”‚          # Step 1: Check for existing result                          â”‚
    â”‚          cached = redis_client.get(cache_key)                         â”‚
    â”‚          if cached:                                                    â”‚
    â”‚              data = json.loads(cached)                                 â”‚
    â”‚              if data['status'] == 'processing':                       â”‚
    â”‚                  return 409, {"error": "Request in progress"}         â”‚
    â”‚              return data['code'], data['response']                    â”‚
    â”‚                                                                         â”‚
    â”‚          # Step 2: Mark as processing (atomic)                        â”‚
    â”‚          acquired = redis_client.set(                                 â”‚
    â”‚              cache_key,                                                â”‚
    â”‚              json.dumps({"status": "processing"}),                    â”‚
    â”‚              nx=True,    # Only if not exists                         â”‚
    â”‚              ex=IDEMPOTENCY_TTL                                       â”‚
    â”‚          )                                                              â”‚
    â”‚                                                                         â”‚
    â”‚          if not acquired:                                              â”‚
    â”‚              return 409, {"error": "Request in progress"}             â”‚
    â”‚                                                                         â”‚
    â”‚          try:                                                          â”‚
    â”‚              # Step 3: Execute actual logic                           â”‚
    â”‚              code, response = func(request)                           â”‚
    â”‚                                                                         â”‚
    â”‚              # Step 4: Cache successful result                        â”‚
    â”‚              if 200 <= code < 300:                                    â”‚
    â”‚                  redis_client.set(                                    â”‚
    â”‚                      cache_key,                                       â”‚
    â”‚                      json.dumps({                                     â”‚
    â”‚                          "status": "complete",                        â”‚
    â”‚                          "code": code,                                â”‚
    â”‚                          "response": response                         â”‚
    â”‚                      }),                                               â”‚
    â”‚                      ex=IDEMPOTENCY_TTL                               â”‚
    â”‚                  )                                                     â”‚
    â”‚              else:                                                     â”‚
    â”‚                  # Don't cache errors - allow retry                   â”‚
    â”‚                  redis_client.delete(cache_key)                       â”‚
    â”‚                                                                         â”‚
    â”‚              return code, response                                    â”‚
    â”‚                                                                         â”‚
    â”‚          except Exception as e:                                       â”‚
    â”‚              # Clear key on exception - allow retry                   â”‚
    â”‚              redis_client.delete(cache_key)                           â”‚
    â”‚              raise                                                     â”‚
    â”‚                                                                         â”‚
    â”‚      return wrapper                                                    â”‚
    â”‚                                                                         â”‚
    â”‚  # Usage                                                                â”‚
    â”‚  @idempotent_handler                                                   â”‚
    â”‚  def create_payment(request):                                          â”‚
    â”‚      # Your payment logic here                                        â”‚
    â”‚      payment = process_payment(request.body)                          â”‚
    â”‚      return 200, {"payment_id": payment.id}                           â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 22.3: IDEMPOTENCY KEY DESIGN
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  WHAT MAKES A GOOD IDEMPOTENCY KEY?                                   â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  GOOD KEYS (Tied to business intent):                          â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  order_123_payment_1       â†’ Order + attempt number           â”‚  â”‚
    â”‚  â”‚  cart_abc_checkout         â†’ Cart session                      â”‚  â”‚
    â”‚  â”‚  invoice_456               â†’ Invoice ID                        â”‚  â”‚
    â”‚  â”‚  user_789_order_20240115   â†’ User + date (daily limit)        â”‚  â”‚
    â”‚  â”‚  txn_uuid-v4               â†’ Client-generated UUID            â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  BAD KEYS:                                                      â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  uuid-v4 (new each request) â†’ Defeats the purpose!            â”‚  â”‚
    â”‚  â”‚  1705312345 (timestamp)     â†’ Not unique enough               â”‚  â”‚
    â”‚  â”‚  user_123 (user ID only)    â†’ User has multiple orders        â”‚  â”‚
    â”‚  â”‚  random_string              â†’ Can't correlate retries         â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â”‚  KEY PRINCIPLE:                                                        â”‚
    â”‚  The same business intent should generate the same idempotency key   â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


KEY SCOPING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  IDEMPOTENCY KEY SCOPE                                                 â”‚
    â”‚                                                                         â”‚
    â”‚  Keys are typically scoped to:                                        â”‚
    â”‚                                                                         â”‚
    â”‚  1. API KEY / MERCHANT                                                 â”‚
    â”‚     Same key from different merchants = different operations          â”‚
    â”‚                                                                         â”‚
    â”‚     Cache key: idem:{api_key}:{idempotency_key}                      â”‚
    â”‚                                                                         â”‚
    â”‚  2. ENDPOINT                                                           â”‚
    â”‚     Same key on different endpoints = different operations            â”‚
    â”‚                                                                         â”‚
    â”‚     Cache key: idem:{endpoint}:{idempotency_key}                     â”‚
    â”‚                                                                         â”‚
    â”‚  3. TIME WINDOW                                                        â”‚
    â”‚     Keys expire after TTL (24 hours typical)                          â”‚
    â”‚     After expiry, same key = new operation                            â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  FULL CACHE KEY FORMAT:                                        â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  idem:{merchant_id}:{endpoint_hash}:{idempotency_key}         â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Example:                                                       â”‚  â”‚
    â”‚  â”‚  idem:merch_abc:payments_create:ord_123_pay_1                  â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 22.4: WHAT TO CACHE
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  RESPONSE CACHING RULES                                                â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚  First Request Result    â”‚  Retry Behavior                    â”‚   â”‚
    â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚  200 Success            â”‚  Return cached 200 âœ“               â”‚   â”‚
    â”‚  â”‚  201 Created            â”‚  Return cached 201 âœ“               â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚  400 Bad Request        â”‚  Process again (fix and retry)     â”‚   â”‚
    â”‚  â”‚  401 Unauthorized       â”‚  Process again                     â”‚   â”‚
    â”‚  â”‚  422 Validation Error   â”‚  Process again (fix input)         â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚  500 Server Error       â”‚  Process again (transient)         â”‚   â”‚
    â”‚  â”‚  502 Bad Gateway        â”‚  Process again (transient)         â”‚   â”‚
    â”‚  â”‚  503 Service Unavail.   â”‚  Process again (transient)         â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚  In Progress (409)      â”‚  Wait and retry                    â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                                         â”‚
    â”‚  RULE: Only cache SUCCESSFUL terminal states                          â”‚
    â”‚  â€¢ Success (2xx) â†’ Cache                                              â”‚
    â”‚  â€¢ Client error (4xx) â†’ Don't cache (let them fix and retry)         â”‚
    â”‚  â€¢ Server error (5xx) â†’ Don't cache (transient, retry may work)      â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WHAT TO STORE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  CACHED VALUE STRUCTURE                                                â”‚
    â”‚                                                                         â”‚
    â”‚  {                                                                      â”‚
    â”‚    "status": "complete",           // or "processing"                 â”‚
    â”‚    "code": 200,                    // HTTP status code                â”‚
    â”‚    "response": {                   // Full response body              â”‚
    â”‚      "payment_id": "pay_xyz",                                         â”‚
    â”‚      "amount": 10000,                                                  â”‚
    â”‚      "status": "succeeded"                                            â”‚
    â”‚    },                                                                   â”‚
    â”‚    "request_hash": "abc123...",    // Optional: verify same request  â”‚
    â”‚    "created_at": "2024-01-15T..."  // For debugging                  â”‚
    â”‚  }                                                                      â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  OPTIONAL: REQUEST PARAMETER VALIDATION                                â”‚
    â”‚                                                                         â”‚
    â”‚  Store hash of request parameters with idempotency key.               â”‚
    â”‚  On retry, verify parameters match.                                   â”‚
    â”‚                                                                         â”‚
    â”‚  Retry with SAME key but DIFFERENT parameters?                        â”‚
    â”‚  â†’ Return 422 "Idempotency key reused with different parameters"     â”‚
    â”‚                                                                         â”‚
    â”‚  def check_params(idem_key, request_body):                            â”‚
    â”‚      stored_hash = redis.hget(f"idem:{idem_key}", "request_hash")    â”‚
    â”‚      current_hash = hash(json.dumps(request_body, sort_keys=True))   â”‚
    â”‚      if stored_hash and stored_hash != current_hash:                  â”‚
    â”‚          return 422, "Parameters don't match original request"       â”‚
    â”‚      return None                                                       â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 22.5: DATABASE-BACKED IDEMPOTENCY
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  REDIS + DATABASE FOR DURABILITY                                       â”‚
    â”‚                                                                         â”‚
    â”‚  Redis alone may lose data on restart. For critical operations,       â”‚
    â”‚  back up with database UNIQUE constraint.                             â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  IDEMPOTENCY TABLE:                                            â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  CREATE TABLE idempotency_keys (                               â”‚  â”‚
    â”‚  â”‚      idempotency_key VARCHAR(255) PRIMARY KEY,                â”‚  â”‚
    â”‚  â”‚      merchant_id VARCHAR(100) NOT NULL,                       â”‚  â”‚
    â”‚  â”‚      endpoint VARCHAR(100) NOT NULL,                          â”‚  â”‚
    â”‚  â”‚      status VARCHAR(20) NOT NULL,  -- processing/complete     â”‚  â”‚
    â”‚  â”‚      request_hash VARCHAR(64),                                 â”‚  â”‚
    â”‚  â”‚      response_code INT,                                        â”‚  â”‚
    â”‚  â”‚      response_body JSONB,                                      â”‚  â”‚
    â”‚  â”‚      created_at TIMESTAMP DEFAULT NOW(),                      â”‚  â”‚
    â”‚  â”‚      expires_at TIMESTAMP NOT NULL,                           â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚      UNIQUE(merchant_id, endpoint, idempotency_key)           â”‚  â”‚
    â”‚  â”‚  );                                                             â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  -- Index for cleanup job                                      â”‚  â”‚
    â”‚  â”‚  CREATE INDEX idx_expires ON idempotency_keys(expires_at);    â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  -- Cleanup expired keys                                       â”‚  â”‚
    â”‚  â”‚  DELETE FROM idempotency_keys WHERE expires_at < NOW();       â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â”‚  TWO-LAYER APPROACH:                                                   â”‚
    â”‚                                                                         â”‚
    â”‚  1. Check Redis first (fast path)                                     â”‚
    â”‚  2. On Redis miss, check database                                     â”‚
    â”‚  3. On database miss, insert with UNIQUE constraint                   â”‚
    â”‚  4. If insert fails (duplicate), another request won                  â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


HANDLING CONCURRENT REQUESTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  RACE CONDITION: Two requests with same key arrive simultaneously     â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Request A                      Request B                      â”‚  â”‚
    â”‚  â”‚     â”‚                              â”‚                            â”‚  â”‚
    â”‚  â”‚     â”‚ Check Redis                  â”‚ Check Redis                â”‚  â”‚
    â”‚  â”‚     â”‚ (not found)                  â”‚ (not found)                â”‚  â”‚
    â”‚  â”‚     â”‚                              â”‚                            â”‚  â”‚
    â”‚  â”‚     â”‚ SET NX (success)             â”‚ SET NX (FAILS!)           â”‚  â”‚
    â”‚  â”‚     â”‚                              â”‚                            â”‚  â”‚
    â”‚  â”‚     â”‚ Process...                   â”‚ Return 409 Conflict       â”‚  â”‚
    â”‚  â”‚     â”‚                              â”‚                            â”‚  â”‚
    â”‚  â”‚     â”‚ Done!                                                     â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â”‚  The NX (Not eXists) flag ensures only ONE request proceeds.         â”‚
    â”‚                                                                         â”‚
    â”‚  DATABASE FALLBACK:                                                    â”‚
    â”‚                                                                         â”‚
    â”‚  BEGIN;                                                                 â”‚
    â”‚  INSERT INTO idempotency_keys (key, status, ...)                      â”‚
    â”‚  VALUES ('abc', 'processing', ...)                                    â”‚
    â”‚  ON CONFLICT (key) DO NOTHING;                                        â”‚
    â”‚                                                                         â”‚
    â”‚  -- Check if WE inserted (row_count = 1) or lost race (row_count = 0)â”‚
    â”‚  COMMIT;                                                                â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 22.6: EXTERNAL SERVICE IDEMPOTENCY
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  FORWARDING IDEMPOTENCY TO EXTERNAL SERVICES                          â”‚
    â”‚                                                                         â”‚
    â”‚  Your system is idempotent, but what about external APIs?             â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Your API â”€â”€â”€â”€â”€â”€â–º Payment Gateway (Stripe)                     â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  If YOU retry to Stripe, Stripe might charge twice!           â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  SOLUTION: Forward your idempotency key to Stripe             â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  stripe.PaymentIntent.create(                                  â”‚  â”‚
    â”‚  â”‚      amount=10000,                                              â”‚  â”‚
    â”‚  â”‚      currency='usd',                                            â”‚  â”‚
    â”‚  â”‚      idempotency_key='ord_123_pay_1'  â† Same key!             â”‚  â”‚
    â”‚  â”‚  )                                                               â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â”‚  Now if your retry hits Stripe again, Stripe returns           â”‚  â”‚
    â”‚  â”‚  the cached result instead of charging again.                  â”‚  â”‚
    â”‚  â”‚                                                                 â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                                                                         â”‚
    â”‚  SERVICES THAT SUPPORT IDEMPOTENCY KEYS:                              â”‚
    â”‚  â€¢ Stripe (Idempotency-Key header)                                   â”‚
    â”‚  â€¢ Braintree                                                          â”‚
    â”‚  â€¢ PayPal                                                              â”‚
    â”‚  â€¢ Twilio                                                              â”‚
    â”‚  â€¢ AWS (client tokens)                                                â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 22.7: ALTERNATIVE PATTERNS
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  OTHER WAYS TO ACHIEVE IDEMPOTENCY                                    â”‚
    â”‚                                                                         â”‚
    â”‚  1. NATURAL IDEMPOTENCY (PUT instead of POST)                        â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
    â”‚  Instead of:  POST /orders { ... }                                   â”‚
    â”‚  Use:         PUT /orders/ord_123 { ... }                            â”‚
    â”‚                                                                         â”‚
    â”‚  PUT is naturally idempotent (sets to same state)                    â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  2. CLIENT-GENERATED IDs                                               â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
    â”‚  Client generates UUID, server rejects duplicates                     â”‚
    â”‚                                                                         â”‚
    â”‚  POST /orders                                                          â”‚
    â”‚  { "order_id": "uuid-from-client", ... }                             â”‚
    â”‚                                                                         â”‚
    â”‚  Server: INSERT with UNIQUE constraint on order_id                   â”‚
    â”‚  Duplicate? Return existing order instead of error                   â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  3. CONDITIONAL REQUESTS (ETags)                                       â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
    â”‚  PUT /users/123                                                        â”‚
    â”‚  If-Match: "etag_abc"    â† Only update if version matches            â”‚
    â”‚                                                                         â”‚
    â”‚  Prevents lost updates from concurrent modifications                 â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  4. DATABASE CONSTRAINTS                                               â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
    â”‚  Natural unique business key prevents duplicates                      â”‚
    â”‚                                                                         â”‚
    â”‚  CREATE TABLE orders (                                                 â”‚
    â”‚      id SERIAL PRIMARY KEY,                                           â”‚
    â”‚      user_id INT,                                                      â”‚
    â”‚      cart_id VARCHAR(100),                                            â”‚
    â”‚      UNIQUE(user_id, cart_id)  â† One order per cart                  â”‚
    â”‚  );                                                                     â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 22.8: QUICK REFERENCE
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  IDEMPOTENT API DESIGN - CHEAT SHEET                                  â”‚
    â”‚                                                                         â”‚
    â”‚  THE PATTERN:                                                          â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
    â”‚  1. Client sends Idempotency-Key header                               â”‚
    â”‚  2. Server checks Redis: key exists?                                  â”‚
    â”‚     â€¢ Yes + complete â†’ Return cached response                        â”‚
    â”‚     â€¢ Yes + processing â†’ Return 409 Conflict                         â”‚
    â”‚     â€¢ No â†’ SET NX, process, cache result                             â”‚
    â”‚                                                                         â”‚
    â”‚  KEY DESIGN:                                                           â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
    â”‚  â€¢ Tied to business intent (order_id, cart_id)                       â”‚
    â”‚  â€¢ Scoped to: merchant + endpoint + time                             â”‚
    â”‚  â€¢ TTL: 24 hours typical                                              â”‚
    â”‚                                                                         â”‚
    â”‚  CACHING RULES:                                                        â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
    â”‚  â€¢ 2xx â†’ Cache (success is terminal)                                 â”‚
    â”‚  â€¢ 4xx â†’ Don't cache (let client fix and retry)                     â”‚
    â”‚  â€¢ 5xx â†’ Don't cache (transient, retry may work)                    â”‚
    â”‚                                                                         â”‚
    â”‚  IMPLEMENTATION:                                                       â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â”‚
    â”‚  â€¢ Redis: SET key value NX EX 86400                                  â”‚
    â”‚  â€¢ Database: UNIQUE constraint backup                                â”‚
    â”‚  â€¢ External: Forward key to Stripe/etc.                              â”‚
    â”‚                                                                         â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
    â”‚                                                                         â”‚
    â”‚  INTERVIEW ANSWER:                                                     â”‚
    â”‚                                                                         â”‚
    â”‚  "To make POST idempotent, I'd use the Idempotency-Key pattern:      â”‚
    â”‚                                                                         â”‚
    â”‚   1. Client sends unique key tied to business intent                 â”‚
    â”‚   2. Server checks Redis with SETNX (atomic)                         â”‚
    â”‚   3. If key exists: return cached response or 409                    â”‚
    â”‚   4. If new: process, cache successful result                        â”‚
    â”‚   5. Use DB UNIQUE constraint as backup                              â”‚
    â”‚   6. Forward key to external services (Stripe)                       â”‚
    â”‚   7. Only cache 2xx responses, allow retry on errors"                â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
                              END OF CHAPTER 22
================================================================================
