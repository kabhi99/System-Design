================================================================================
                    DOCKER MULTI-STAGE BUILDS
                    Chapter 6: Building Optimized Images
================================================================================

Multi-stage builds let you create small, production-ready images by
separating build-time dependencies from runtime requirements.


================================================================================
SECTION 6.1: THE SIZE PROBLEM
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  WHY IMAGE SIZE MATTERS                                               â”‚
    â”‚                                                                         â”‚
    â”‚  Large images cause:                                                   â”‚
    â”‚  â€¢ Slow deployments (longer pull times)                              â”‚
    â”‚  â€¢ More storage costs                                                 â”‚
    â”‚  â€¢ Larger attack surface (more packages = more vulnerabilities)     â”‚
    â”‚  â€¢ Slower container startup                                          â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  TYPICAL GO APPLICATION                                               â”‚
    â”‚                                                                         â”‚
    â”‚  BEFORE (Single-stage):                                               â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ FROM golang:1.21                                               â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚ WORKDIR /app                                                   â”‚   â”‚
    â”‚  â”‚ COPY . .                                                       â”‚   â”‚
    â”‚  â”‚ RUN go build -o myapp                                          â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚ CMD ["./myapp"]                                                â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                                         â”‚
    â”‚  Image size: ~1.1 GB! ğŸ˜±                                              â”‚
    â”‚                                                                         â”‚
    â”‚  Contains:                                                             â”‚
    â”‚  â€¢ Full Go compiler (not needed at runtime)                         â”‚
    â”‚  â€¢ All build tools                                                   â”‚
    â”‚  â€¢ Source code                                                       â”‚
    â”‚  â€¢ Downloaded dependencies                                           â”‚
    â”‚  â€¢ Your tiny 10MB binary                                            â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 6.2: MULTI-STAGE BUILD SOLUTION
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  MULTI-STAGE DOCKERFILE                                               â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ # Stage 1: Build                                               â”‚   â”‚
    â”‚  â”‚ FROM golang:1.21 AS builder                                    â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚ WORKDIR /app                                                   â”‚   â”‚
    â”‚  â”‚ COPY go.mod go.sum ./                                          â”‚   â”‚
    â”‚  â”‚ RUN go mod download                                            â”‚   â”‚
    â”‚  â”‚ COPY . .                                                       â”‚   â”‚
    â”‚  â”‚ RUN CGO_ENABLED=0 go build -o myapp                            â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚ # Stage 2: Production                                          â”‚   â”‚
    â”‚  â”‚ FROM alpine:3.18                                               â”‚   â”‚
    â”‚  â”‚                                                                â”‚   â”‚
    â”‚  â”‚ COPY --from=builder /app/myapp /myapp                          â”‚   â”‚
    â”‚  â”‚ CMD ["/myapp"]                                                 â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                                                                         â”‚
    â”‚  Image size: ~15 MB! ğŸ‰                                              â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  HOW IT WORKS                                                          â”‚
    â”‚                                                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
    â”‚  â”‚ Stage 1: builder    â”‚      â”‚ Stage 2: final      â”‚                 â”‚
    â”‚  â”‚                     â”‚      â”‚                     â”‚                 â”‚
    â”‚  â”‚ golang:1.21 (1.1GB) â”‚      â”‚ alpine:3.18 (5MB)   â”‚                 â”‚
    â”‚  â”‚ + source code       â”‚      â”‚ + your binary (10MB)â”‚                 â”‚
    â”‚  â”‚ + dependencies      â”‚ â”€â”€â”€â–º â”‚                     â”‚                 â”‚
    â”‚  â”‚ + build tools       â”‚ COPY â”‚ = 15MB total        â”‚                 â”‚
    â”‚  â”‚ = compile binary    â”‚ only â”‚                     â”‚                 â”‚
    â”‚  â”‚                     â”‚binaryâ”‚                     â”‚                 â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
    â”‚        (discarded)                  (final image)                     â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 6.3: LANGUAGE-SPECIFIC EXAMPLES
================================================================================

NODE.JS MULTI-STAGE BUILD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  # Stage 1: Build                                                      â”‚
    â”‚  FROM node:20-alpine AS builder                                        â”‚
    â”‚                                                                         â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY package*.json ./                                                  â”‚
    â”‚  RUN npm ci                                                             â”‚
    â”‚  COPY . .                                                               â”‚
    â”‚  RUN npm run build                                                      â”‚
    â”‚                                                                         â”‚
    â”‚  # Stage 2: Production dependencies only                              â”‚
    â”‚  FROM node:20-alpine AS deps                                           â”‚
    â”‚                                                                         â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY package*.json ./                                                  â”‚
    â”‚  RUN npm ci --only=production                                          â”‚
    â”‚                                                                         â”‚
    â”‚  # Stage 3: Final                                                      â”‚
    â”‚  FROM node:20-alpine                                                    â”‚
    â”‚                                                                         â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY --from=deps /app/node_modules ./node_modules                    â”‚
    â”‚  COPY --from=builder /app/dist ./dist                                 â”‚
    â”‚  COPY package*.json ./                                                  â”‚
    â”‚                                                                         â”‚
    â”‚  USER node                                                              â”‚
    â”‚  CMD ["node", "dist/index.js"]                                         â”‚
    â”‚                                                                         â”‚
    â”‚  Result: No devDependencies, no source code, just production files   â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


JAVA MULTI-STAGE BUILD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  # Stage 1: Build with Maven                                          â”‚
    â”‚  FROM maven:3.9-eclipse-temurin-17 AS builder                         â”‚
    â”‚                                                                         â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY pom.xml .                                                         â”‚
    â”‚  RUN mvn dependency:go-offline                                         â”‚
    â”‚  COPY src ./src                                                         â”‚
    â”‚  RUN mvn package -DskipTests                                           â”‚
    â”‚                                                                         â”‚
    â”‚  # Stage 2: Runtime only                                               â”‚
    â”‚  FROM eclipse-temurin:17-jre-alpine                                   â”‚
    â”‚                                                                         â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY --from=builder /app/target/*.jar app.jar                        â”‚
    â”‚                                                                         â”‚
    â”‚  USER 1000                                                              â”‚
    â”‚  EXPOSE 8080                                                            â”‚
    â”‚  CMD ["java", "-jar", "app.jar"]                                       â”‚
    â”‚                                                                         â”‚
    â”‚  Build image: ~800MB (Maven + JDK)                                   â”‚
    â”‚  Final image: ~150MB (JRE only)                                      â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PYTHON MULTI-STAGE BUILD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  # Stage 1: Build wheels                                               â”‚
    â”‚  FROM python:3.11-slim AS builder                                     â”‚
    â”‚                                                                         â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  RUN apt-get update && apt-get install -y --no-install-recommends \  â”‚
    â”‚      build-essential gcc                                               â”‚
    â”‚                                                                         â”‚
    â”‚  COPY requirements.txt .                                               â”‚
    â”‚  RUN pip wheel --no-cache-dir --wheel-dir /wheels -r requirements.txtâ”‚
    â”‚                                                                         â”‚
    â”‚  # Stage 2: Production                                                 â”‚
    â”‚  FROM python:3.11-slim                                                 â”‚
    â”‚                                                                         â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY --from=builder /wheels /wheels                                  â”‚
    â”‚  RUN pip install --no-cache-dir /wheels/*                             â”‚
    â”‚                                                                         â”‚
    â”‚  COPY . .                                                               â”‚
    â”‚  USER 1000                                                              â”‚
    â”‚  CMD ["python", "app.py"]                                              â”‚
    â”‚                                                                         â”‚
    â”‚  No build tools in final image (gcc, build-essential removed)        â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 6.4: ADVANCED TECHNIQUES
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  SCRATCH IMAGE (Minimal possible)                                     â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                      â”‚
    â”‚                                                                         â”‚
    â”‚  For statically compiled binaries (Go, Rust).                        â”‚
    â”‚  Zero base imageâ€”just your binary!                                    â”‚
    â”‚                                                                         â”‚
    â”‚  FROM golang:1.21 AS builder                                          â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY . .                                                               â”‚
    â”‚  RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo \       â”‚
    â”‚      -ldflags="-w -s" -o myapp                                        â”‚
    â”‚                                                                         â”‚
    â”‚  FROM scratch                                                           â”‚
    â”‚  COPY --from=builder /app/myapp /myapp                                â”‚
    â”‚  COPY --from=builder /etc/ssl/certs/ca-certificates.crt \            â”‚
    â”‚      /etc/ssl/certs/                                                    â”‚
    â”‚  CMD ["/myapp"]                                                        â”‚
    â”‚                                                                         â”‚
    â”‚  Image size: ~5-10MB (just your binary + certs)                      â”‚
    â”‚                                                                         â”‚
    â”‚  Note: scratch has NO shell, no debugging tools                      â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  DISTROLESS IMAGES (Google)                                           â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                            â”‚
    â”‚                                                                         â”‚
    â”‚  Minimal images with just runtime, no shell or package manager.      â”‚
    â”‚                                                                         â”‚
    â”‚  FROM golang:1.21 AS builder                                          â”‚
    â”‚  # ... build ...                                                        â”‚
    â”‚                                                                         â”‚
    â”‚  FROM gcr.io/distroless/static-debian12                               â”‚
    â”‚  COPY --from=builder /app/myapp /myapp                                â”‚
    â”‚  CMD ["/myapp"]                                                        â”‚
    â”‚                                                                         â”‚
    â”‚  Available distroless images:                                          â”‚
    â”‚  â€¢ gcr.io/distroless/static (for static binaries)                    â”‚
    â”‚  â€¢ gcr.io/distroless/base (glibc)                                     â”‚
    â”‚  â€¢ gcr.io/distroless/java17                                           â”‚
    â”‚  â€¢ gcr.io/distroless/python3                                          â”‚
    â”‚  â€¢ gcr.io/distroless/nodejs18                                         â”‚
    â”‚                                                                         â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚                                                                         â”‚
    â”‚  BUILD TARGET SELECTION                                               â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                â”‚
    â”‚                                                                         â”‚
    â”‚  Build specific stages for different purposes.                       â”‚
    â”‚                                                                         â”‚
    â”‚  FROM node:20-alpine AS base                                           â”‚
    â”‚  WORKDIR /app                                                          â”‚
    â”‚  COPY package*.json ./                                                  â”‚
    â”‚                                                                         â”‚
    â”‚  FROM base AS dev                                                       â”‚
    â”‚  RUN npm install                                                        â”‚
    â”‚  CMD ["npm", "run", "dev"]                                             â”‚
    â”‚                                                                         â”‚
    â”‚  FROM base AS test                                                      â”‚
    â”‚  RUN npm ci                                                             â”‚
    â”‚  COPY . .                                                               â”‚
    â”‚  CMD ["npm", "test"]                                                    â”‚
    â”‚                                                                         â”‚
    â”‚  FROM base AS prod                                                      â”‚
    â”‚  RUN npm ci --only=production                                          â”‚
    â”‚  COPY . .                                                               â”‚
    â”‚  CMD ["npm", "start"]                                                   â”‚
    â”‚                                                                         â”‚
    â”‚  # Build specific target:                                              â”‚
    â”‚  docker build --target dev -t myapp:dev .                             â”‚
    â”‚  docker build --target test -t myapp:test .                           â”‚
    â”‚  docker build --target prod -t myapp:prod .                           â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
SECTION 6.5: OPTIMIZATION TIPS
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  IMAGE SIZE REDUCTION TECHNIQUES                                      â”‚
    â”‚                                                                         â”‚
    â”‚  1. USE SMALLER BASE IMAGES                                            â”‚
    â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
    â”‚     node:20         â†’ 1.1GB                                           â”‚
    â”‚     node:20-slim    â†’ 200MB                                           â”‚
    â”‚     node:20-alpine  â†’ 130MB                                           â”‚
    â”‚                                                                         â”‚
    â”‚  2. MINIMIZE LAYERS                                                    â”‚
    â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
    â”‚     # Bad: 3 layers                                                   â”‚
    â”‚     RUN apt-get update                                                â”‚
    â”‚     RUN apt-get install -y curl                                       â”‚
    â”‚     RUN rm -rf /var/lib/apt/lists/*                                  â”‚
    â”‚                                                                         â”‚
    â”‚     # Good: 1 layer                                                   â”‚
    â”‚     RUN apt-get update && \                                           â”‚
    â”‚         apt-get install -y curl && \                                  â”‚
    â”‚         rm -rf /var/lib/apt/lists/*                                  â”‚
    â”‚                                                                         â”‚
    â”‚  3. CLEAN UP IN SAME LAYER                                            â”‚
    â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
    â”‚     # Cache cleaning must be in same RUN                              â”‚
    â”‚     RUN pip install -r requirements.txt && \                         â”‚
    â”‚         rm -rf ~/.cache/pip                                           â”‚
    â”‚                                                                         â”‚
    â”‚  4. USE .dockerignore                                                  â”‚
    â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
    â”‚     # .dockerignore                                                   â”‚
    â”‚     node_modules                                                       â”‚
    â”‚     .git                                                               â”‚
    â”‚     *.md                                                               â”‚
    â”‚     Dockerfile                                                         â”‚
    â”‚     .env                                                               â”‚
    â”‚                                                                         â”‚
    â”‚  5. ORDER LAYERS BY CHANGE FREQUENCY                                   â”‚
    â”‚     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
    â”‚     # Rarely changes (cached)                                         â”‚
    â”‚     COPY package.json .                                               â”‚
    â”‚     RUN npm install                                                    â”‚
    â”‚                                                                         â”‚
    â”‚     # Frequently changes (rebuild from here)                         â”‚
    â”‚     COPY src ./src                                                     â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
CHAPTER SUMMARY
================================================================================

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                                         â”‚
    â”‚  MULTI-STAGE BUILDS - KEY TAKEAWAYS                                   â”‚
    â”‚                                                                         â”‚
    â”‚  CONCEPT                                                               â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
    â”‚  â€¢ Multiple FROM statements in one Dockerfile                        â”‚
    â”‚  â€¢ Each FROM starts a new stage                                      â”‚
    â”‚  â€¢ COPY --from=stagename copies between stages                      â”‚
    â”‚  â€¢ Only final stage is in the output image                          â”‚
    â”‚                                                                         â”‚
    â”‚  BENEFITS                                                              â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
    â”‚  â€¢ Smaller images (10-100x reduction possible)                       â”‚
    â”‚  â€¢ Faster deployments                                                 â”‚
    â”‚  â€¢ Fewer vulnerabilities                                             â”‚
    â”‚  â€¢ Build tools not in production                                     â”‚
    â”‚                                                                         â”‚
    â”‚  BASE IMAGE CHOICES                                                    â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
    â”‚  â€¢ alpine: Small, musl libc (some compatibility issues)             â”‚
    â”‚  â€¢ slim: Debian-based, smaller than full                            â”‚
    â”‚  â€¢ distroless: No shell, minimal attack surface                     â”‚
    â”‚  â€¢ scratch: Empty, for static binaries only                         â”‚
    â”‚                                                                         â”‚
    â”‚  COMMANDS                                                              â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
    â”‚  docker build --target <stage> -t image:tag .                        â”‚
    â”‚  COPY --from=<stage> /src /dest                                      â”‚
    â”‚                                                                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
                              END OF CHAPTER 6
================================================================================

